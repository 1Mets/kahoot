// ==UserScript==
// @name         Michael's Kahoot Cheats
// @version      7.6
// @description  Kahoot cheats
// @namespace    https://
// @match        https://kahoot.it/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    
    // === CONFIGURATION ===
    const CONFIG = {
        uiToggleKey: 'q',
        markersToggleKey: 'b',
        selfDestructKey: 'x',
        ctrlRequired: true,
        markerColor: '#000000',
        markerSize: '6px',
        detectionInterval: 100, // Slightly slower for better performance
        apiEndpoint: 'https://damp-leaf-16aa.johnwee.workers.dev/api-proxy/',
        searchEndpoint: 'https://damp-leaf-16aa.johnwee.workers.dev/rest/kahoots/'
    };
    
    // === CORNER MAPPING (FIXED: opposite corners) ===
    const CORNER_MAP = {
        0: 'bottom-right',  // Answer 0 (top-left) ‚Üí marker bottom-right
        1: 'bottom-left',   // Answer 1 (top-right) ‚Üí marker bottom-left
        2: 'top-right',     // Answer 2 (bottom-left) ‚Üí marker top-right
        3: 'top-left'       // Answer 3 (bottom-right) ‚Üí marker top-left
    };
    
    // === STATE MANAGEMENT ===
    let state = {
        visible: true,
        questions: [],
        currentQuestion: -1,
        gamePin: null,
        quizLoaded: false,
        isMinimized: false,
        markersEnabled: false,
        active: true,
        markers: new Map(),
        lastQuestionCheck: -1,
        searchResults: [],
        isSearching: false,
        currentQuizId: null,
        markedAnswers: new Set(),
        lastMarkerCheck: 0,
        markerCheckInterval: 500 // Check for markers every 500ms
    };
    
    // === DARK UI CREATION ===
    const ui = document.createElement('div');
    Object.assign(ui.style, {
        position: 'fixed',
        top: '30px',
        left: '30px',
        width: '380px',
        backgroundColor: '#000000',
        borderRadius: '12px',
        boxShadow: '0 10px 40px rgba(0, 0, 0, 0.9)',
        zIndex: '99999',
        fontFamily: '"Segoe UI", "Roboto", sans-serif',
        border: '1px solid #222222',
        transition: 'all 0.25s ease',
        overflow: 'hidden'
    });
    
    // Drag Header - WITH DEMON EMOJI üòà
    const header = document.createElement('div');
    Object.assign(header.style, {
        padding: '16px 20px',
        background: 'linear-gradient(135deg, #111111 0%, #000000 100%)',
        cursor: 'move',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        borderBottom: '1px solid #222222',
        userSelect: 'none'
    });
    
    const title = document.createElement('div');
    title.innerHTML = '<span style="color:#ffffff;font-size:20px;margin-right:10px">üòà</span><span style="color:#ffffff;font-weight:600;font-size:16px">Michael\'s Kahoot Cheats v7.6</span>';
    header.appendChild(title);
    
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.gap = '8px';
    
    const minimizeBtn = createControlBtn('‚àí', '#222222');
    const closeBtn = createControlBtn('√ó', '#444444');
    
    controls.appendChild(minimizeBtn);
    controls.appendChild(closeBtn);
    header.appendChild(controls);
    ui.appendChild(header);
    
    // Content Area
    const content = document.createElement('div');
    content.style.padding = '20px';
    
    // Quiz Lookup Section
    const lookupSection = document.createElement('div');
    lookupSection.style.marginBottom = '20px';
    
    const lookupLabel = document.createElement('div');
    lookupLabel.textContent = 'QUIZ LOOKUP';
    Object.assign(lookupLabel.style, {
        color: '#ffffff',
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        marginBottom: '10px',
        textTransform: 'uppercase'
    });
    
    // Input with dropdown
    const lookupContainer = document.createElement('div');
    lookupContainer.style.position = 'relative';
    
    const searchInput = document.createElement('input');
    Object.assign(searchInput.style, {
        width: '100%',
        padding: '12px 40px 12px 12px',
        background: '#111111',
        border: '2px solid #222222',
        borderRadius: '8px',
        color: '#ffffff',
        outline: 'none',
        fontSize: '14px',
        boxSizing: 'border-box'
    });
    searchInput.placeholder = 'Search quiz name or paste Quiz ID...';
    searchInput.id = 'searchInput';
    
    const searchIcon = document.createElement('div');
    searchIcon.innerHTML = 'üîç';
    Object.assign(searchIcon.style, {
        position: 'absolute',
        right: '12px',
        top: '50%',
        transform: 'translateY(-50%)',
        color: '#ffffff',
        cursor: 'pointer',
        fontSize: '16px'
    });
    
    lookupContainer.appendChild(searchInput);
    lookupContainer.appendChild(searchIcon);
    
    // Search results dropdown
    const resultsDropdown = document.createElement('div');
    resultsDropdown.id = 'resultsDropdown';
    Object.assign(resultsDropdown.style, {
        position: 'absolute',
        top: '100%',
        left: '0',
        width: '100%',
        maxHeight: '200px',
        overflowY: 'auto',
        backgroundColor: '#111111',
        border: '1px solid #222222',
        borderRadius: '8px',
        marginTop: '5px',
        display: 'none',
        zIndex: '100000'
    });
    
    lookupContainer.appendChild(resultsDropdown);
    lookupSection.appendChild(lookupLabel);
    lookupSection.appendChild(lookupContainer);
    content.appendChild(lookupSection);
    
    // Features Section
    const featuresSection = document.createElement('div');
    featuresSection.style.marginBottom = '20px';
    
    const featuresLabel = document.createElement('div');
    featuresLabel.textContent = 'FEATURES';
    Object.assign(featuresLabel.style, {
        color: '#ffffff',
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        marginBottom: '12px',
        textTransform: 'uppercase'
    });
    
    const featuresGrid = document.createElement('div');
    featuresGrid.style.display = 'grid';
    featuresGrid.style.gridTemplateColumns = '1fr';
    featuresGrid.style.gap = '12px';
    
    // Highlight Answers Toggle
    const highlightToggle = document.createElement('div');
    highlightToggle.style.cssText = `
        padding: 12px;
        background: #111111;
        border-radius: 8px;
        border: 1px solid #222222;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
    `;
    
    const highlightLabel = document.createElement('span');
    highlightLabel.textContent = 'Highlight Answers (Ctrl+B)';
    highlightLabel.style.cssText = `
        color: #ffffff;
        font-size: 14px;
        font-weight: 500;
    `;
    
    const highlightSwitch = document.createElement('div');
    highlightSwitch.id = 'highlightSwitch';
    highlightSwitch.style.cssText = `
        position: relative;
        width: 44px;
        height: 24px;
        background: #222222;
        border-radius: 12px;
        transition: all 0.3s;
    `;
    
    const highlightKnob = document.createElement('div');
    highlightKnob.id = 'highlightKnob';
    highlightKnob.style.cssText = `
        position: absolute;
        width: 18px;
        height: 18px;
        background: #666666;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: all 0.3s;
        transform: translateX(0);
    `;
    
    highlightSwitch.appendChild(highlightKnob);
    highlightToggle.appendChild(highlightLabel);
    highlightToggle.appendChild(highlightSwitch);
    featuresGrid.appendChild(highlightToggle);
    
    featuresSection.appendChild(featuresLabel);
    featuresSection.appendChild(featuresGrid);
    content.appendChild(featuresSection);
    
    // Status Indicator
    const statusIndicator = document.createElement('div');
    statusIndicator.id = 'statusIndicator';
    statusIndicator.style.cssText = `
        padding: 8px 12px;
        background: #111111;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 12px;
        color: #ffffff;
        border: 1px solid #222222;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.3s;
    `;
    
    const statusDot = document.createElement('div');
    statusDot.id = 'statusDot';
    statusDot.style.cssText = `
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #444444;
        transition: background 0.3s;
    `;
    
    const statusText = document.createElement('span');
    statusText.id = 'statusText';
    statusText.textContent = '';
    
    statusIndicator.appendChild(statusDot);
    statusIndicator.appendChild(statusText);
    featuresSection.appendChild(statusIndicator);
    
    // Game Info Section
    const infoSection = document.createElement('div');
    
    const infoLabel = document.createElement('div');
    infoLabel.textContent = 'GAME INFO';
    Object.assign(infoLabel.style, {
        color: '#ffffff',
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        marginBottom: '12px',
        textTransform: 'uppercase'
    });
    
    const infoCard = document.createElement('div');
    Object.assign(infoCard.style, {
        background: '#111111',
        borderRadius: '8px',
        padding: '15px',
        border: '1px solid #222222'
    });
    
    const quizInfoContainer = document.createElement('div');
    quizInfoContainer.style.cssText = `
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    `;
    
    const questionDisplay = document.createElement('div');
    questionDisplay.id = 'questionDisplay';
    questionDisplay.textContent = 'Questions: 0/0';
    Object.assign(questionDisplay.style, {
        color: '#ffffff',
        fontSize: '13px'
    });
    
    const unloadButton = document.createElement('button');
    unloadButton.id = 'unloadButton';
    unloadButton.textContent = 'Unload';
    Object.assign(unloadButton.style, {
        padding: '4px 12px',
        background: '#444444',
        color: '#ffffff',
        border: 'none',
        borderRadius: '4px',
        fontSize: '11px',
        fontWeight: '600',
        cursor: 'pointer',
        opacity: '0.7',
        display: 'none',
        transition: 'all 0.2s'
    });
    
    quizInfoContainer.appendChild(questionDisplay);
    quizInfoContainer.appendChild(unloadButton);
    
    const pinDisplay = document.createElement('div');
    pinDisplay.id = 'pinDisplay';
    pinDisplay.textContent = 'Game PIN: None';
    Object.assign(pinDisplay.style, {
        color: '#ffffff',
        fontSize: '13px',
        fontWeight: '500',
        marginTop: '8px'
    });
    
    infoCard.appendChild(quizInfoContainer);
    infoCard.appendChild(pinDisplay);
    infoSection.appendChild(infoLabel);
    infoSection.appendChild(infoCard);
    content.appendChild(infoSection);
    
    // Status Bar
    const statusBar = document.createElement('div');
    Object.assign(statusBar.style, {
        marginTop: '20px',
        padding: '10px',
        background: '#111111',
        borderRadius: '6px',
        fontSize: '11px',
        color: '#ffffff',
        textAlign: 'center',
        border: '1px solid #222222'
    });
    statusBar.innerHTML = `
        Toggle UI: <kbd style="background:#222222;padding:2px 6px;border-radius:4px;color:#ffffff">Ctrl+Q</kbd> 
        | Highlight: <kbd style="background:#222222;padding:2px 6px;border-radius:4px;color:#ffffff">Ctrl+B</kbd>
        | Destroy: <kbd style="background:#333333;padding:2px 6px;border-radius:4px;color:#ffffff">Ctrl+X</kbd>
    `;
    
    content.appendChild(statusBar);
    ui.appendChild(content);
    document.body.appendChild(ui);
    
    // === MARKER STYLE ===
    const markerStyle = document.createElement('style');
    markerStyle.id = 'corner-marker-style';
    markerStyle.textContent = `
        .kahoot-marker {
            position: absolute !important;
            width: ${CONFIG.markerSize} !important;
            height: ${CONFIG.markerSize} !important;
            background-color: ${CONFIG.markerColor} !important;
            border-radius: 1px !important;
            pointer-events: none !important;
            z-index: 10000 !important;
        }
        
        .kahoot-marker[data-position="top-left"] {
            top: 3px !important;
            left: 3px !important;
        }
        
        .kahoot-marker[data-position="top-right"] {
            top: 3px !important;
            right: 3px !important;
        }
        
        .kahoot-marker[data-position="bottom-left"] {
            bottom: 3px !important;
            left: 3px !important;
        }
        
        .kahoot-marker[data-position="bottom-right"] {
            bottom: 3px !important;
            right: 3px !important;
        }
    `;
    document.head.appendChild(markerStyle);
    
    // === INITIALIZATION ===
    initialize();
    
    function initialize() {
        setupDrag();
        setupControls();
        setupKeyboard();
        startMonitoring();
        updateToggleVisual();
        updateStatusIndicator();
        
        // Silence console
        if (window.console) {
            console.clear();
            ['log', 'error', 'warn', 'info', 'debug'].forEach(method => {
                console[method] = function(){};
            });
        }
    }
    
    function setupDrag() {
        let isDragging = false;
        let offsetX = 0;
        let offsetY = 0;
        
        const startDrag = (e) => {
            isDragging = true;
            const rect = ui.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            ui.style.userSelect = 'none';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        };
        
        const drag = (e) => {
            if (!isDragging) return;
            
            let x = e.clientX - offsetX;
            let y = e.clientY - offsetY;
            
            const maxX = window.innerWidth - ui.offsetWidth;
            const maxY = window.innerHeight - ui.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            ui.style.transform = `translate(${x}px, ${y}px)`;
            ui.style.left = '0';
            ui.style.top = '0';
            
            e.preventDefault();
        };
        
        const stopDrag = () => {
            if (!isDragging) return;
            
            isDragging = false;
            
            const transform = ui.style.transform;
            const match = transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
            if (match) {
                const x = parseFloat(match[1]);
                const y = parseFloat(match[2]);
                
                ui.style.left = x + 'px';
                ui.style.top = y + 'px';
                ui.style.transform = 'none';
            }
            
            ui.style.userSelect = '';
            document.body.style.userSelect = '';
        };
        
        // Mouse events
        header.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        
        // Touch events
        header.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                startDrag(e.touches[0]);
            }
        });
        
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1 && isDragging) {
                drag(e.touches[0]);
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchend', stopDrag);
        document.addEventListener('touchcancel', stopDrag);
        
        header.style.userSelect = 'none';
        header.style.webkitUserSelect = 'none';
    }
    
    function setupControls() {
        // Minimize/Close
        minimizeBtn.addEventListener('click', () => {
            state.isMinimized = !state.isMinimized;
            content.style.display = state.isMinimized ? 'none' : 'block';
            minimizeBtn.textContent = state.isMinimized ? '+' : '‚àí';
        });
        
        closeBtn.addEventListener('click', selfDestruct);
        
        // Search functionality
        searchIcon.addEventListener('click', () => {
            performSearch(searchInput.value.trim());
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch(searchInput.value.trim());
            }
        });
        
        searchInput.addEventListener('input', (e) => {
            const query = searchInput.value.trim();
            if (query.length >= 3) {
                clearTimeout(searchInput.timeout);
                searchInput.timeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            } else if (query.length === 0) {
                hideResults();
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!lookupContainer.contains(e.target)) {
                hideResults();
            }
        });
        
        // Highlight Answers Toggle - WITH INSTANT ACTION
        highlightToggle.addEventListener('click', toggleMarkers);
        
        unloadButton.addEventListener('click', unloadQuiz);
        unloadButton.addEventListener('mouseenter', () => {
            unloadButton.style.opacity = '1';
        });
        unloadButton.addEventListener('mouseleave', () => {
            unloadButton.style.opacity = '0.7';
        });
    }
    
    function toggleMarkers() {
        state.markersEnabled = !state.markersEnabled;
        updateToggleVisual();
        updateStatusIndicator();
        
        if (state.markersEnabled) {
            statusDot.style.background = '#000000';
            // INSTANTLY check for and apply markers
            checkAndApplyMarkers(true);
        } else {
            statusDot.style.background = '#444444';
            removeAllMarkers();
        }
    }
    
    function performSearch(query) {
        if (!query || state.isSearching) return;
        
        const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (uuidPattern.test(query)) {
            fetchQuiz(query);
            hideResults();
            return;
        }
        
        state.isSearching = true;
        resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">Searching...</div>';
        resultsDropdown.style.display = 'block';
        
        const searchUrl = `${CONFIG.searchEndpoint}?query=${encodeURIComponent(query)}`;
        
        fetch(searchUrl)
            .then(response => {
                if (!response.ok) throw new Error();
                return response.json();
            })
            .then(data => {
                if (data.entities) {
                    state.searchResults = data.entities;
                } else if (Array.isArray(data)) {
                    state.searchResults = data;
                } else {
                    state.searchResults = [];
                }
                displayResults();
                state.isSearching = false;
            })
            .catch(() => {
                resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">Search failed. Try a Quiz ID instead.</div>';
                resultsDropdown.style.display = 'block';
                state.isSearching = false;
            });
    }
    
    function displayResults() {
        if (state.searchResults.length === 0) {
            resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">No quizzes found</div>';
            resultsDropdown.style.display = 'block';
            return;
        }
        
        resultsDropdown.innerHTML = '';
        
        state.searchResults.forEach((result) => {
            const card = result.card || result;
            if (!card || !card.uuid) return;
            
            const item = document.createElement('div');
            item.style.cssText = `
                padding: 12px;
                border-bottom: 1px solid #222;
                cursor: pointer;
                transition: background 0.2s;
                display: flex;
                flex-direction: column;
                gap: 4px;
            `;
            
            const quizName = card.title || card.name || 'Untitled Quiz';
            const questionCount = card.number_of_questions || card.questions_count || card.number_of_questions || '?';
            
            item.innerHTML = `
                <div style="color: #ffffff; font-size: 13px; font-weight: 500;">${quizName}</div>
                <div style="color: #cccccc; font-size: 11px; display: flex; align-items: center; gap: 8px;">
                    <span>${questionCount} questions</span>
                    <button style="margin-left: auto; background: #444; color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 11px; cursor: pointer;">Load</button>
                </div>
            `;
            
            item.addEventListener('mouseenter', () => {
                item.style.background = '#222';
            });
            
            item.addEventListener('mouseleave', () => {
                item.style.background = 'transparent';
            });
            
            item.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    searchInput.value = card.uuid;
                    hideResults();
                    fetchQuiz(card.uuid);
                }
            });
            
            item.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                searchInput.value = card.uuid;
                hideResults();
                fetchQuiz(card.uuid);
            });
            
            resultsDropdown.appendChild(item);
        });
        
        resultsDropdown.style.display = 'block';
    }
    
    function hideResults() {
        resultsDropdown.style.display = 'none';
    }
    
    function updateToggleVisual() {
        if (state.markersEnabled) {
            highlightSwitch.style.background = '#444444';
            highlightKnob.style.transform = 'translateX(20px)';
            highlightKnob.style.background = '#ffffff';
        } else {
            highlightSwitch.style.background = '#222222';
            highlightKnob.style.transform = 'translateX(0)';
            highlightKnob.style.background = '#666666';
        }
    }
    
    function updateStatusIndicator() {
        if (state.markersEnabled) {
            statusText.textContent = 'Highlight: ON';
            statusIndicator.style.opacity = '1';
        } else {
            statusIndicator.style.opacity = '0';
        }
    }
    
    function setupKeyboard() {
        document.addEventListener('keydown', (e) => {
            if (!e.ctrlKey) return;
            
            const key = e.key.toLowerCase();
            
            if (key === CONFIG.uiToggleKey) {
                e.preventDefault();
                state.visible = !state.visible;
                ui.style.opacity = state.visible ? '1' : '0';
                ui.style.pointerEvents = state.visible ? 'all' : 'none';
            }
            
            if (key === CONFIG.markersToggleKey) {
                e.preventDefault();
                toggleMarkers();
            }
            
            if (key === CONFIG.selfDestructKey) {
                e.preventDefault();
                selfDestruct();
            }
        });
    }
    
    function unloadQuiz() {
        state.questions = [];
        state.quizLoaded = false;
        state.currentQuestion = -1;
        state.currentQuizId = null;
        state.markedAnswers.clear();
        state.lastQuestionCheck = -1;
        
        removeAllMarkers();
        
        questionDisplay.textContent = 'Questions: 0/0';
        questionDisplay.style.color = '#ffffff';
        unloadButton.style.display = 'none';
        
        searchInput.value = '';
        
        state.markersEnabled = false;
        updateToggleVisual();
        updateStatusIndicator();
    }
    
    function selfDestruct() {
        if (!state.active) return;
        
        state.active = false;
        state.markersEnabled = false;
        
        unloadQuiz();
        
        if (window.michaelsMonitoringInterval) {
            clearInterval(window.michaelsMonitoringInterval);
        }
        
        document.removeEventListener('keydown', setupKeyboard);
        
        if (markerStyle.parentNode) {
            markerStyle.parentNode.removeChild(markerStyle);
        }
        
        ui.style.transform = 'scale(0.8)';
        ui.style.opacity = '0';
        
        setTimeout(() => {
            if (ui.parentNode) {
                ui.parentNode.removeChild(ui);
            }
            
            state.markers.clear();
            document.onkeydown = null;
        }, 200);
    }
    
    async function fetchQuiz(quizId) {
        if (!quizId) return;
        
        resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">Loading...</div>';
        resultsDropdown.style.display = 'block';
        
        try {
            const response = await fetch(`${CONFIG.apiEndpoint}${encodeURIComponent(quizId)}`);
            if (!response.ok) {
                throw new Error();
            }
            
            const data = await response.json();
            processQuizData(data, quizId);
            hideResults();
            
        } catch {
            resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">Failed to load quiz</div>';
            resultsDropdown.style.display = 'block';
            setTimeout(hideResults, 2000);
        }
    }
    
    function processQuizData(data, quizId) {
        state.questions = parseQuestions(data.questions || []);
        state.quizLoaded = true;
        state.currentQuestion = -1;
        state.lastQuestionCheck = -1;
        state.currentQuizId = quizId;
        state.markedAnswers.clear();
        
        removeAllMarkers();
        
        questionDisplay.textContent = `Questions: ${state.questions.length} loaded`;
        questionDisplay.style.color = '#ffffff';
        
        unloadButton.style.display = 'block';
        searchInput.value = quizId;
        
        // If markers are enabled, check immediately
        if (state.markersEnabled) {
            checkAndApplyMarkers(true);
        }
    }
    
    function parseQuestions(questions) {
        return questions.map(q => {
            const parsed = {
                type: q.type,
                time: q.time || 10000,
                choices: q.choices || []
            };
            
            if (['quiz', 'multiple_select_quiz', 'true_false', 'open_ended'].includes(q.type)) {
                parsed.correctIndices = [];
                
                q.choices.forEach((choice, index) => {
                    if (choice.correct) {
                        parsed.correctIndices.push(index);
                    }
                });
            }
            
            return parsed;
        });
    }
    
    function startMonitoring() {
        window.michaelsMonitoringInterval = setInterval(() => {
            if (!state.active) return;
            
            detectGamePin();
            
            const currentQuestion = detectCurrentQuestion();
            if (currentQuestion !== state.currentQuestion && currentQuestion >= 0) {
                state.currentQuestion = currentQuestion;
                state.markedAnswers.clear();
                onQuestionChange();
            }
            
            // CONTINUOUS MARKER CHECKING WHEN ENABLED
            if (state.markersEnabled) {
                const now = Date.now();
                if (now - state.lastMarkerCheck > state.markerCheckInterval) {
                    state.lastMarkerCheck = now;
                    checkAndApplyMarkers(false); // Regular check
                }
                maintainMarkers();
            }
        }, CONFIG.detectionInterval);
    }
    
    function detectCurrentQuestion() {
        const questionCounter = document.querySelector('[data-functional-selector="question-index-counter"]');
        if (questionCounter) {
            const text = questionCounter.textContent.trim();
            const match = text.match(/(\d+)/);
            if (match) return parseInt(match[1]) - 1;
        }
        
        const altCounter = document.querySelector('.question-index-counter, .counter, [class*="question"]');
        if (altCounter) {
            const text = altCounter.textContent.trim();
            const match = text.match(/(\d+)/);
            if (match) return parseInt(match[1]) - 1;
        }
        
        return -1;
    }
    
    function onQuestionChange() {
        if (state.questions.length > 0) {
            questionDisplay.textContent = `Question: ${state.currentQuestion + 1}/${state.questions.length}`;
        }
        
        removeAllMarkers();
        
        // If markers are enabled, check immediately on question change
        if (state.markersEnabled) {
            checkAndApplyMarkers(true);
        }
    }
    
    function checkAndApplyMarkers(forceImmediate = false) {
        if (!state.markersEnabled || state.currentQuestion < 0 || 
            state.currentQuestion >= state.questions.length) {
            return;
        }
        
        const question = state.questions[state.currentQuestion];
        if (!question || !question.correctIndices || question.correctIndices.length === 0) {
            return;
        }
        
        const correctIndex = question.correctIndices[0];
        if (correctIndex === undefined) return;
        
        // If we already have a marker for this answer, skip
        if (state.markedAnswers.has(correctIndex)) {
            return;
        }
        
        // Get the correct corner position
        const cornerPosition = CORNER_MAP[correctIndex] || 'bottom-right';
        
        if (forceImmediate) {
            // Immediate attempt with no delay
            const answerButton = findAnswerButton(correctIndex);
            if (answerButton) {
                placeMarker(answerButton, cornerPosition, correctIndex);
            }
        } else {
            // Regular check with retry logic
            let attempts = 0;
            const maxAttempts = 5;
            
            const tryApplyMarker = () => {
                attempts++;
                
                const answerButton = findAnswerButton(correctIndex);
                if (answerButton && !state.markers.has(answerButton)) {
                    placeMarker(answerButton, cornerPosition, correctIndex);
                } else if (!answerButton && attempts < maxAttempts) {
                    setTimeout(tryApplyMarker, 100);
                }
            };
            
            tryApplyMarker();
        }
    }
    
    function placeMarker(button, cornerPosition, answerIndex) {
        const marker = document.createElement('div');
        marker.className = 'kahoot-marker';
        marker.setAttribute('data-position', cornerPosition);
        marker.setAttribute('data-answer', answerIndex);
        
        // Ensure button has proper positioning
        if (getComputedStyle(button).position === 'static') {
            button.style.position = 'relative';
        }
        
        button.appendChild(marker);
        state.markers.set(button, marker);
        state.markedAnswers.add(answerIndex);
    }
    
    function findAnswerButton(index) {
        // Multiple selector attempts
        const selectors = [
            `button[data-functional-selector="answer-${index}"]`,
            `[data-functional-selector="answer-${index}"]`,
            `.answer-${index}`,
            `[data-answer-index="${index}"]`,
            `button[data-index="${index}"]`,
            `.choice-${index}`,
            `[data-testid="answer-${index}"]`
        ];
        
        for (const selector of selectors) {
            const button = document.querySelector(selector);
            if (button) return button;
        }
        
        // Fallback: all answer buttons
        const allAnswerButtons = document.querySelectorAll('button[data-functional-selector^="answer-"]');
        if (allAnswerButtons.length > index) {
            return allAnswerButtons[index];
        }
        
        // Last resort: all buttons
        const allButtons = document.querySelectorAll('button');
        if (allButtons.length > index) {
            // Filter to only answer-like buttons (ones that look like answers)
            const answerLikeButtons = Array.from(allButtons).filter(btn => {
                const text = btn.textContent || '';
                return text.length > 0 && text.length < 100; // Answers are usually short
            });
            
            if (answerLikeButtons.length > index) {
                return answerLikeButtons[index];
            }
        }
        
        return null;
    }
    
    function maintainMarkers() {
        state.markers.forEach((marker, button) => {
            if (!document.body.contains(button) || !document.body.contains(marker)) {
                state.markers.delete(button);
                state.markedAnswers.delete(parseInt(marker.getAttribute('data-answer')));
                return;
            }
            
            if (!button.contains(marker)) {
                if (getComputedStyle(button).position === 'static') {
                    button.style.position = 'relative';
                }
                button.appendChild(marker);
            }
        });
    }
    
    function removeAllMarkers() {
        state.markers.forEach((marker, button) => {
            if (marker && marker.parentNode === button) {
                button.removeChild(marker);
                
                if (button.style.position === 'relative' && button.children.length === 0) {
                    button.style.position = '';
                }
            }
        });
        
        state.markers.clear();
        state.markedAnswers.clear();
        
        // Clean up any orphaned markers
        const allMarkers = document.querySelectorAll('.kahoot-marker');
        allMarkers.forEach(marker => {
            if (marker.parentNode) {
                marker.parentNode.removeChild(marker);
            }
        });
    }
    
    function detectGamePin() {
        const pinInput = document.querySelector('input[name="gameId"], input[placeholder*="PIN"]');
        if (pinInput && pinInput.value) {
            state.gamePin = pinInput.value;
            pinDisplay.textContent = `Game PIN: ${state.gamePin}`;
            return;
        }
        
        const elements = document.querySelectorAll('[data-functional-selector*="pin"], .game-pin, .pin');
        for (const el of elements) {
            const text = el.textContent || el.innerText;
            const match = text.match(/\d{4,8}/);
            if (match) {
                state.gamePin = match[0];
                pinDisplay.textContent = `Game PIN: ${state.gamePin}`;
                return;
            }
        }
    }
    
    // === HELPER FUNCTIONS ===
    
    function createControlBtn(text, bgColor) {
        const btn = document.createElement('button');
        btn.textContent = text;
        Object.assign(btn.style, {
            width: '28px',
            height: '28px',
            borderRadius: '6px',
            background: bgColor,
            border: 'none',
            color: '#ffffff',
            cursor: 'pointer',
            fontSize: '16px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            transition: 'all 0.2s'
        });
        
        btn.addEventListener('mouseenter', () => {
            btn.style.transform = 'scale(1.1)';
        });
        
        btn.addEventListener('mouseleave', () => {
            btn.style.transform = 'scale(1)';
        });
        
        return btn;
    }
})();
