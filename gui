// ==UserScript==
// @name         Michael's Kahoot Cheats
// @version      7.8
// @description  Kahoot cheats
// @namespace    https://
// @match        https://kahoot.it/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    
    // === CONFIGURATION ===
    const CONFIG = {
        uiToggleKey: 'q',
        markersToggleKey: 'b',
        selfDestructKey: 'x',
        ctrlRequired: true,
        markerColor: '#000000',
        markerSize: '8px',
        detectionInterval: 100,
        apiEndpoint: 'https://damp-leaf-16aa.johnwee.workers.dev/api-proxy/',
        searchEndpoint: 'https://damp-leaf-16aa.johnwee.workers.dev/rest/kahoots/'
    };
    
    // === CORNER MAPPING ===
    const CORNER_MAP = {
        0: 'bottom-right',  // Answer 0 (top-left) ‚Üí marker bottom-right
        1: 'bottom-left',   // Answer 1 (top-right) ‚Üí marker bottom-left
        2: 'top-right',     // Answer 2 (bottom-left) ‚Üí marker top-right
        3: 'top-left'       // Answer 3 (bottom-right) ‚Üí marker top-left
    };
    
    // === STATE MANAGEMENT ===
    let state = {
        visible: true,
        questions: [],
        currentQuestion: -1,
        gamePin: null,
        quizLoaded: false,
        markersEnabled: false,
        active: true,
        currentQuizId: null,
        isSearching: false
    };
    
    // === DARK UI CREATION ===
    const ui = document.createElement('div');
    Object.assign(ui.style, {
        position: 'fixed',
        top: '30px',
        left: '30px',
        width: '380px',
        backgroundColor: '#000000',
        borderRadius: '12px',
        boxShadow: '0 10px 40px rgba(0, 0, 0, 0.9)',
        zIndex: '99999',
        fontFamily: '"Segoe UI", "Roboto", sans-serif',
        border: '1px solid #222222',
        overflow: 'hidden'
    });
    
    // Drag Header
    const header = document.createElement('div');
    Object.assign(header.style, {
        padding: '16px 20px',
        background: 'linear-gradient(135deg, #111111 0%, #000000 100%)',
        cursor: 'move',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        borderBottom: '1px solid #222222',
        userSelect: 'none',
        WebkitUserSelect: 'none'
    });
    
    const title = document.createElement('div');
    title.innerHTML = '<span style="color:#ffffff;font-size:20px;margin-right:10px">üòà</span><span style="color:#ffffff;font-weight:600;font-size:16px">Michael\'s Kahoot Cheats v7.8</span>';
    header.appendChild(title);
    
    const closeBtn = createControlBtn('√ó', '#444444');
    header.appendChild(closeBtn);
    ui.appendChild(header);
    
    // Content Area
    const content = document.createElement('div');
    content.style.padding = '20px';
    
    // Quiz Lookup Section
    const lookupSection = document.createElement('div');
    lookupSection.style.marginBottom = '20px';
    
    const lookupLabel = document.createElement('div');
    lookupLabel.textContent = 'QUIZ LOOKUP';
    Object.assign(lookupLabel.style, {
        color: '#ffffff',
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        marginBottom: '10px',
        textTransform: 'uppercase'
    });
    
    const lookupContainer = document.createElement('div');
    lookupContainer.style.position = 'relative';
    
    const searchInput = document.createElement('input');
    Object.assign(searchInput.style, {
        width: '100%',
        padding: '12px 40px 12px 12px',
        background: '#111111',
        border: '2px solid #222222',
        borderRadius: '8px',
        color: '#ffffff',
        outline: 'none',
        fontSize: '14px',
        boxSizing: 'border-box'
    });
    searchInput.placeholder = 'Search quiz name or paste Quiz ID...';
    searchInput.id = 'kahootSearchInput';
    
    const searchIcon = document.createElement('div');
    searchIcon.innerHTML = 'üîç';
    Object.assign(searchIcon.style, {
        position: 'absolute',
        right: '12px',
        top: '50%',
        transform: 'translateY(-50%)',
        color: '#ffffff',
        cursor: 'pointer',
        fontSize: '16px'
    });
    
    // Search results dropdown
    const resultsDropdown = document.createElement('div');
    resultsDropdown.id = 'kahootResultsDropdown';
    Object.assign(resultsDropdown.style, {
        position: 'absolute',
        top: '100%',
        left: '0',
        width: '100%',
        maxHeight: '200px',
        overflowY: 'auto',
        backgroundColor: '#111111',
        border: '1px solid #222222',
        borderRadius: '8px',
        marginTop: '5px',
        display: 'none',
        zIndex: '100000'
    });
    
    lookupContainer.appendChild(searchInput);
    lookupContainer.appendChild(searchIcon);
    lookupContainer.appendChild(resultsDropdown);
    lookupSection.appendChild(lookupLabel);
    lookupSection.appendChild(lookupContainer);
    content.appendChild(lookupSection);
    
    // Features Section
    const featuresSection = document.createElement('div');
    featuresSection.style.marginBottom = '20px';
    
    const featuresLabel = document.createElement('div');
    featuresLabel.textContent = 'FEATURES';
    Object.assign(featuresLabel.style, {
        color: '#ffffff',
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        marginBottom: '12px',
        textTransform: 'uppercase'
    });
    
    // Highlight Toggle
    const highlightToggle = document.createElement('div');
    highlightToggle.style.cssText = `
        padding: 12px;
        background: #111111;
        border-radius: 8px;
        border: 1px solid #222222;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    `;
    
    const highlightLabel = document.createElement('span');
    highlightLabel.textContent = 'Highlight Answers (Ctrl+B)';
    highlightLabel.style.cssText = `
        color: #ffffff;
        font-size: 14px;
        font-weight: 500;
    `;
    
    const highlightSwitch = document.createElement('div');
    highlightSwitch.style.cssText = `
        position: relative;
        width: 44px;
        height: 24px;
        background: #222222;
        border-radius: 12px;
    `;
    
    const highlightKnob = document.createElement('div');
    highlightKnob.style.cssText = `
        position: absolute;
        width: 18px;
        height: 18px;
        background: #666666;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform 0.2s;
        transform: translateX(0);
    `;
    
    highlightSwitch.appendChild(highlightKnob);
    highlightToggle.appendChild(highlightLabel);
    highlightToggle.appendChild(highlightSwitch);
    featuresSection.appendChild(featuresLabel);
    featuresSection.appendChild(highlightToggle);
    content.appendChild(featuresSection);
    
    // Game Info Section
    const infoSection = document.createElement('div');
    
    const infoLabel = document.createElement('div');
    infoLabel.textContent = 'GAME INFO';
    Object.assign(infoLabel.style, {
        color: '#ffffff',
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        marginBottom: '12px',
        textTransform: 'uppercase'
    });
    
    const infoCard = document.createElement('div');
    Object.assign(infoCard.style, {
        background: '#111111',
        borderRadius: '8px',
        padding: '15px',
        border: '1px solid #222222'
    });
    
    const questionDisplay = document.createElement('div');
    questionDisplay.id = 'questionDisplay';
    questionDisplay.textContent = 'Questions: 0/0';
    Object.assign(questionDisplay.style, {
        color: '#ffffff',
        fontSize: '13px',
        marginBottom: '8px'
    });
    
    const pinDisplay = document.createElement('div');
    pinDisplay.id = 'pinDisplay';
    pinDisplay.textContent = 'Game PIN: None';
    Object.assign(pinDisplay.style, {
        color: '#ffffff',
        fontSize: '13px',
        fontWeight: '500'
    });
    
    infoCard.appendChild(questionDisplay);
    infoCard.appendChild(pinDisplay);
    infoSection.appendChild(infoLabel);
    infoSection.appendChild(infoCard);
    content.appendChild(infoSection);
    
    // Status Bar
    const statusBar = document.createElement('div');
    Object.assign(statusBar.style, {
        marginTop: '20px',
        padding: '10px',
        background: '#111111',
        borderRadius: '6px',
        fontSize: '11px',
        color: '#ffffff',
        textAlign: 'center',
        border: '1px solid #222222'
    });
    statusBar.innerHTML = `
        Toggle UI: <kbd style="background:#222222;padding:2px 6px;border-radius:4px;color:#ffffff">Ctrl+Q</kbd> 
        | Highlight: <kbd style="background:#222222;padding:2px 6px;border-radius:4px;color:#ffffff">Ctrl+B</kbd>
        | Destroy: <kbd style="background:#333333;padding:2px 6px;border-radius:4px;color:#ffffff">Ctrl+X</kbd>
    `;
    
    content.appendChild(statusBar);
    ui.appendChild(content);
    document.body.appendChild(ui);
    
    // === MARKER STYLE ===
    const markerStyle = document.createElement('style');
    markerStyle.textContent = `
        .kahoot-marker {
            position: absolute !important;
            width: ${CONFIG.markerSize} !important;
            height: ${CONFIG.markerSize} !important;
            background-color: ${CONFIG.markerColor} !important;
            border-radius: 1px !important;
            pointer-events: none !important;
            z-index: 10000 !important;
        }
        
        .kahoot-marker.top-left {
            top: 2px !important;
            left: 2px !important;
        }
        
        .kahoot-marker.top-right {
            top: 2px !important;
            right: 2px !important;
        }
        
        .kahoot-marker.bottom-left {
            bottom: 2px !important;
            left: 2px !important;
        }
        
        .kahoot-marker.bottom-right {
            bottom: 2px !important;
            right: 2px !important;
        }
    `;
    document.head.appendChild(markerStyle);
    
    // === INITIALIZATION ===
    initialize();
    
    function initialize() {
        setupDrag();
        setupControls();
        setupKeyboard();
        startMonitoring();
        
        // Silence console
        if (window.console) {
            console.clear();
            ['log', 'error', 'warn', 'info', 'debug'].forEach(method => {
                console[method] = function(){};
            });
        }
    }
    
    // === FIXED DRAGGING ===
    function setupDrag() {
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;
        
        const startDrag = (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = ui.offsetLeft;
            initialTop = ui.offsetTop;
            
            e.preventDefault();
            return false;
        };
        
        const drag = (e) => {
            if (!isDragging) return;
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            let newLeft = initialLeft + dx;
            let newTop = initialTop + dy;
            
            // Boundary checking
            const maxX = window.innerWidth - ui.offsetWidth;
            const maxY = window.innerHeight - ui.offsetHeight;
            
            newLeft = Math.max(0, Math.min(newLeft, maxX));
            newTop = Math.max(0, Math.min(newTop, maxY));
            
            ui.style.left = newLeft + 'px';
            ui.style.top = newTop + 'px';
            
            e.preventDefault();
        };
        
        const stopDrag = () => {
            isDragging = false;
        };
        
        // Mouse events
        header.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        
        // Touch events
        header.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                startDrag(e.touches[0]);
            }
        });
        
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1 && isDragging) {
                drag(e.touches[0]);
            }
        }, { passive: false });
        
        document.addEventListener('touchend', stopDrag);
    }
    
    function setupControls() {
        // Close button
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(ui);
            state.active = false;
        });
        
        // Search functionality with dropdown
        searchIcon.addEventListener('click', () => {
            performSearch(searchInput.value.trim());
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch(searchInput.value.trim());
            }
        });
        
        searchInput.addEventListener('input', (e) => {
            const query = searchInput.value.trim();
            if (query.length >= 3) {
                clearTimeout(searchInput.timeout);
                searchInput.timeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            } else if (query.length === 0) {
                hideResults();
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!lookupContainer.contains(e.target)) {
                hideResults();
            }
        });
        
        // Highlight toggle
        highlightToggle.addEventListener('click', () => {
            state.markersEnabled = !state.markersEnabled;
            
            if (state.markersEnabled) {
                highlightKnob.style.transform = 'translateX(20px)';
                highlightKnob.style.background = '#ffffff';
                highlightSwitch.style.background = '#444444';
                applyMarkers();
            } else {
                highlightKnob.style.transform = 'translateX(0)';
                highlightKnob.style.background = '#666666';
                highlightSwitch.style.background = '#222222';
                removeMarkers();
            }
        });
    }
    
    // === SEARCH DROPDOWN FUNCTIONS ===
    function performSearch(query) {
        if (!query || state.isSearching) return;
        
        const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (uuidPattern.test(query)) {
            fetchQuiz(query);
            hideResults();
            return;
        }
        
        state.isSearching = true;
        showLoading();
        
        fetch(`${CONFIG.searchEndpoint}?query=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error();
                return response.json();
            })
            .then(data => {
                displaySearchResults(data);
                state.isSearching = false;
            })
            .catch(() => {
                resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">Search failed. Try a Quiz ID instead.</div>';
                resultsDropdown.style.display = 'block';
                state.isSearching = false;
            });
    }
    
    function showLoading() {
        resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">Searching...</div>';
        resultsDropdown.style.display = 'block';
    }
    
    function displaySearchResults(data) {
        let results = [];
        if (data.entities) {
            results = data.entities;
        } else if (Array.isArray(data)) {
            results = data;
        }
        
        if (results.length === 0) {
            resultsDropdown.innerHTML = '<div style="padding: 10px; color: #ffffff; text-align: center;">No quizzes found</div>';
            resultsDropdown.style.display = 'block';
            return;
        }
        
        resultsDropdown.innerHTML = '';
        
        results.slice(0, 10).forEach((result) => {
            const card = result.card || result;
            if (!card || !card.uuid) return;
            
            const item = document.createElement('div');
            item.style.cssText = `
                padding: 12px;
                border-bottom: 1px solid #222;
                cursor: pointer;
                transition: background 0.2s;
                display: flex;
                flex-direction: column;
                gap: 4px;
            `;
            
            const quizName = card.title || card.name || 'Untitled Quiz';
            const questionCount = card.number_of_questions || card.questions_count || card.number_of_questions || '?';
            
            item.innerHTML = `
                <div style="color: #ffffff; font-size: 13px; font-weight: 500;">${quizName}</div>
                <div style="color: #cccccc; font-size: 11px; display: flex; align-items: center; gap: 8px;">
                    <span>${questionCount} questions</span>
                    <button style="margin-left: auto; background: #444; color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 11px; cursor: pointer;">Load</button>
                </div>
            `;
            
            item.addEventListener('mouseenter', () => {
                item.style.background = '#222';
            });
            
            item.addEventListener('mouseleave', () => {
                item.style.background = 'transparent';
            });
            
            item.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    searchInput.value = card.uuid;
                    hideResults();
                    fetchQuiz(card.uuid);
                }
            });
            
            item.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                searchInput.value = card.uuid;
                hideResults();
                fetchQuiz(card.uuid);
            });
            
            resultsDropdown.appendChild(item);
        });
        
        resultsDropdown.style.display = 'block';
    }
    
    function hideResults() {
        resultsDropdown.style.display = 'none';
    }
    
    // === SIMPLE MARKER SYSTEM ===
    function applyMarkers() {
        if (!state.markersEnabled || state.currentQuestion < 0 || 
            !state.questions[state.currentQuestion]) return;
        
        removeMarkers();
        
        const question = state.questions[state.currentQuestion];
        if (!question.correctIndices || question.correctIndices.length === 0) return;
        
        const correctIndex = question.correctIndices[0];
        const cornerClass = getCornerClass(correctIndex);
        
        // Try multiple times with delay
        let attempts = 0;
        const tryApply = () => {
            attempts++;
            
            const button = findAnswerButton(correctIndex);
            if (button) {
                const marker = document.createElement('div');
                marker.className = `kahoot-marker ${cornerClass}`;
                button.style.position = 'relative';
                button.appendChild(marker);
            } else if (attempts < 10) {
                setTimeout(tryApply, 100);
            }
        };
        
        tryApply();
    }
    
    function removeMarkers() {
        document.querySelectorAll('.kahoot-marker').forEach(marker => {
            marker.parentNode?.removeChild(marker);
        });
    }
    
    function getCornerClass(answerIndex) {
        switch(answerIndex) {
            case 0: return 'bottom-right';  // top-left answer
            case 1: return 'bottom-left';   // top-right answer
            case 2: return 'top-right';     // bottom-left answer
            case 3: return 'top-left';      // bottom-right answer
            default: return 'bottom-right';
        }
    }
    
    function findAnswerButton(index) {
        // Direct selector - Kahoot's actual structure
        const selectors = [
            `button[data-functional-selector="answer-${index}"]`,
            `[data-functional-selector="answer-${index}"]`,
            `.answer-${index}`
        ];
        
        for (const selector of selectors) {
            const button = document.querySelector(selector);
            if (button) return button;
        }
        
        // Fallback: all answer buttons
        const allButtons = document.querySelectorAll('button[data-functional-selector^="answer-"]');
        if (allButtons.length > index) {
            return allButtons[index];
        }
        
        return null;
    }
    
    function setupKeyboard() {
        document.addEventListener('keydown', (e) => {
            if (!e.ctrlKey) return;
            
            const key = e.key.toLowerCase();
            
            if (key === 'q') {
                e.preventDefault();
                state.visible = !state.visible;
                ui.style.opacity = state.visible ? '1' : '0';
                ui.style.pointerEvents = state.visible ? 'all' : 'none';
            }
            
            if (key === 'b') {
                e.preventDefault();
                highlightToggle.click();
            }
            
            if (key === 'x') {
                e.preventDefault();
                document.body.removeChild(ui);
                state.active = false;
            }
        });
    }
    
    function startMonitoring() {
        setInterval(() => {
            if (!state.active) return;
            
            detectGamePin();
            detectCurrentQuestion();
            
            // Re-apply markers if enabled and question changed
            if (state.markersEnabled) {
                applyMarkers();
            }
        }, CONFIG.detectionInterval);
    }
    
    function detectCurrentQuestion() {
        const questionCounter = document.querySelector('[data-functional-selector="question-index-counter"]');
        if (questionCounter) {
            const text = questionCounter.textContent.trim();
            const match = text.match(/(\d+)/);
            if (match) {
                const newQuestion = parseInt(match[1]) - 1;
                if (newQuestion !== state.currentQuestion) {
                    state.currentQuestion = newQuestion;
                    questionDisplay.textContent = `Question: ${state.currentQuestion + 1}/${state.questions.length || 0}`;
                    
                    // Re-apply markers immediately
                    if (state.markersEnabled) {
                        setTimeout(applyMarkers, 50);
                    }
                }
            }
        }
    }
    
    function detectGamePin() {
        const pinInput = document.querySelector('input[name="gameId"]');
        if (pinInput && pinInput.value) {
            state.gamePin = pinInput.value;
            pinDisplay.textContent = `Game PIN: ${state.gamePin}`;
        }
    }
    
    function fetchQuiz(quizId) {
        fetch(`${CONFIG.apiEndpoint}${quizId}`)
            .then(r => r.json())
            .then(data => {
                state.questions = (data.questions || []).map(q => ({
                    type: q.type,
                    correctIndices: (q.choices || []).reduce((acc, choice, idx) => {
                        if (choice.correct) acc.push(idx);
                        return acc;
                    }, [])
                }));
                
                questionDisplay.textContent = `Questions: ${state.questions.length} loaded`;
                searchInput.value = quizId;
                state.currentQuizId = quizId;
            });
    }
    
    // Helper function
    function createControlBtn(text, bgColor) {
        const btn = document.createElement('button');
        btn.textContent = text;
        Object.assign(btn.style, {
            width: '28px',
            height: '28px',
            borderRadius: '6px',
            background: bgColor,
            border: 'none',
            color: '#ffffff',
            cursor: 'pointer',
            fontSize: '16px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
        });
        
        return btn;
    }
})();
